---
title: "ACP Enrollment Dashboard"
author: "Christine Parker | ILSR"
date: "`r Sys.Date()`"
---

```{r setup, include = FALSE, echo=FALSE}

library(tidyverse)
library(tidycensus)
census_api_key(Sys.getenv("CENSUS_API_KEY"))
library(stringr)
library(arcgisbinding)
arc.check_product()
library(gt)
library(extrafont)
library(rvest)
library(janitor)
library(RSocrata)
library(dplyr)
library(readr)
library(usdata)
library(tinytex)
library(scales)
library(readxl)
library(arsenal)
library(lubridate)
library(broom)
library(openxlsx)
library(tigris)
library(tidyverse)
library(rgdal)
library(maptools)
library(mapproj)
library(rgeos)
library(tigris)
library(sf)
library(lme4)
library(sjPlot)
library(data.table)
library(ipumsr)

#Options-------------------
options(scipen = 999)
options(digits = 3)
options(tigris_use_cache = TRUE)
```

```{r load pums data,cache = TRUE,cache.lazy = FALSE, echo=FALSE}


#load pums data that was downloaded from FTP site
ha <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_hus/psam_husa.csv")
#h_vars <- as.data.frame(names(ha))
hb <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_hus/psam_husb.csv")
hc <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_hus/psam_husc.csv")
hd <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_hus/psam_husd.csv")
h.data <- bind_rows(ha,hb,hc,hd)
rm(ha,hb,hc,hd)

h.data2 <- h.data %>% select(RT,ST, TYPEHUGQ, SERIALNO, WGTP, FS) %>% mutate(FS = ifelse(is.na(FS) == TRUE, 0, FS), TYPEHUGQ = ifelse(is.na(TYPEHUGQ) == TRUE, 0, TYPEHUGQ)) %>% subset(TYPEHUGQ == 1)
rm(h.data)

pa <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_pus/psam_pusa.csv")
pb <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_pus/psam_pusb.csv")
pc <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_pus/psam_pusc.csv")
pd <- fread("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/csv_pus/psam_pusd.csv")
p.data <- bind_rows(pa,pb,pc,pd)
rm(pa,pb,pc,pd)

p.data2 <- p.data %>% select(RT,ST, SERIALNO, SPORDER, PWGTP, PAP, HINS4, SSIP, POVPIP) 
rm(p.data)


p.labeled <- p.data2 %>%   subset(RT == "P") %>%#determines eligibility based on receipt of government benefit 
 mutate(pe = ifelse(is.na(POVPIP) == FALSE & between(POVPIP, 0, 200), 1, 0), HINS4 = replace_na(HINS4,-1), PAP = replace_na(PAP, -1), SSIP = replace_na(SSIP, -1)) 

p.filt <- p.labeled %>% mutate(pe = ifelse(HINS4 == 1 | PAP > 0 | SSIP > 0, 1, pe)) %>%
 group_by(ST, SERIALNO) %>% summarize(all.pe = sum(pe)) %>% subset(all.pe > 0)

eligible.all <- full_join(x = h.data2, y = p.filt, by = c("SERIALNO", "ST")) %>% 
  mutate(FS = ifelse(is.na(FS) == TRUE, 0, FS), all.pe = ifelse(is.na(all.pe) == TRUE, 0, all.pe)) %>%
  mutate(P = ifelse(FS == 1 | all.pe > 0, "y", "n")) %>%
  subset(P == "y")

st_eligible <- eligible.all %>% distinct(SERIALNO, .keep_all = TRUE) %>% subset(is.na(WGTP) == FALSE) %>% group_by(ST) %>% summarize(hh_eligible = sum(WGTP))
sum(eligible.all$WGTP)

#make sure all state codes have leading zero
st_eligible$ST <-  str_pad(st_eligible$ST, width = 2, side = c("left"), pad = 0)

```

```{r Load & Edit Enrollment Data, echo=FALSE, cache=TRUE, cache.lazy=FALSE, results='hide'}
#load ACP enrollment data from spreadsheet (manually updated each week)
#edit the variable name to reflect the most recent data update
ACP7aug <- "C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACPWeeklyEnroll.xlsx"

data(fips_codes) #creates dataframe of all state and county fips codes
fips_states <- fips_codes %>% select(state_name,state,state_code) 
fips_states <- distinct(fips_states, .keep_all = TRUE) #condense down to single row per state

#download zip to zcta crosswalk from UDSMapper here: https://udsmapper.org/zip-code-to-zcta-crosswalk/
zip2zcta <- zip2zcta <- read_excel("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/CrosswalkData/ZIPCodetoZCTACrosswalk2021UDS.xlsx") %>% select(ZIP_CODE, STATE,ZCTA) %>%
  rename("zipcode" = "ZIP_CODE", "state" = "STATE", "zcta" = "ZCTA")

##loads enrollment by zipcode data (this dataset does not include subscription vs. device & claims details)
acp_zip <- read_excel("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP-Enrollments-by-Zip-as-of-June-1-2023.xlsx", sheet = 1, col_names = TRUE) %>% clean_names() %>% rename("enrollments" = "subscribers_in_zip") %>% select(zipcode, enrollments) %>% 
  right_join(y = zip2zcta, by = "zipcode")

#load total spent by zipcode (to join with congressional data)
claims2022 <- read_excel("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP-Claims-by-Zip-January-December-2022.xlsx")
claims2023 <- read_excel("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP-Claims-by-Zip-January-May-2023.xlsx") 

claims22_23 <- bind_rows(claims2022,claims2023)

acp_zip_spent <- claims22_23 %>% clean_names() %>% select(zipcode,device_support, total_support) %>%
  mutate(zipcode = str_pad(zipcode, width = 5, side = c("left"), pad = 0)) %>%
  group_by(zipcode) %>% 
  summarize(total_support = sum(na.omit(total_support)), device_support = sum(na.omit(device_support)))

#write this to the dashboard folder each time to use for other claims-related elements
write.csv(claims22_23,"C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP_claims22_23.csv")

#make sure all zipcodes have leading zeros & convert to character
acp_zip$zipcode <-  str_pad(acp_zip$zipcode, width = 5, side = c("left"), pad = 0)
acp_zip$zipcode <- as.character(acp_zip$zipcode)


##UPDATE THIS EVERY TIME
ACPstates <-read_excel(path = ACP7aug, sheet = 4, col_names = TRUE) %>%
  select(State,HH_7aug23) %>% 
  left_join(y = fips_states, by = c("State" = "state_name"))

#-------------------------------------------------------
#read in benton cities and add in the FIPS numbers to enable join in GIS
benton <- read.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/ACP/BentonCities.xlsx", sheet = 1)

#read in the Benton zipcode list
bentondata <- arc.open("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/BentonCitiesZipcodesNames")

#-------------------------------------------------------
#Total number of households (HHs) that fall within 200% of the poverty line defined by US. Dept of Health & Human Services https://aspe.hhs.gov/topics/poverty-economic-mobility/poverty-guidelines/prior-hhs-poverty-guidelines-federal-register-references/2019-poverty-guidelines#guidelines
 #load in this spreadsheet which contains the max value for each household income bracket from the ACS table B19001
inc.max.vals <- read.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Dashboard/acs_HH_max_income_range.csv")

#-------------------------------------------------------
#load in zcta data for mapping
usZIP <- zctas(cb = TRUE, year = 2020)
#arcgisbinding::arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/usZIP", data = usZIP, overwrite=TRUE)

#-------------------------------------------------------
#NATIONAL DATA
acp_national <-read_excel(path = ACP7aug, sheet = 2, col_names = TRUE) %>% clean_names() %>%
  #summarize data by year and month - total households, broken down into tribal and non-tribal
  group_by(month(date), year(date)) %>% summarize(allHH = max(total_households), ntHH = max(non_tribal), tHH = max(tribal)) %>% 
  #estimate how much of the fund has been used so far - using tribal and non-tribal HH enrollment
  mutate(nt_fund = ntHH*30, t_fund = tHH*75) %>%
  #total fund use so far & create new year & month columns to be able to arrange...
  mutate(TotalUsed = nt_fund + t_fund, TotalUsed2.5 = TotalUsed*1.025) %>% rename(month = 'month(date)', year = 'year(date)') %>% arrange(year, month) %>% mutate(CumUsed2.5 = cumsum(TotalUsed2.5))
  #and create a month index value to use in the analysis
   acp_national$monthBYyear <- 1:nrow(acp_national)
   
   
#-------------------------------------------------------   
#numerical list of months to use in prediction formula below (need to change this for each new month)
future <- data.frame(monthBYyear = c(29:238))
   
   

```

```{r ACP State Analysis,cache = TRUE,cache.lazy = FALSE, echo=FALSE, results='hide'}
#import the list of zcta's for AK and HI
ak.zcta <- zctas(cb = FALSE, year = 2010, state = 02) #load AK zcta's
hi.zcta <- zctas(cb = FALSE, year = 2010, state = 15) #load HI zcta's


#variables indicating the 1-person household 200% fpl value (p1xx), and the rate of change for each additional person (p2xx)
#https://aspe.hhs.gov/sites/default/files/private/aspe-files/107166/2021-percentage-poverty-tool_0.pdf
p148 <- 25760 
p248 <- 9080 #2 person FPL - 1 person FPL
p1ak <- 32180
p2ak <- 11360
p1hi <- 29640
p2hi <- 10440

#download household income data from acs at state level
HHincome_state.1 <- get_acs(survey = "acs5", geography = "state", table = "B19001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names()  #download version without geography 

#download household income data from acs
totalHH_state <- get_acs(survey = "acs5", geography = "state", variables = "B19001_001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate,moe) %>% rename("total_hh" = "estimate") %>%  #download version without geography 
mutate(total_hh = ifelse(total_hh == 0, moe, total_hh)) %>% select(-moe)
  
#download average household size from acs
HH.size_state <- get_acs(survey = "acs5", geography = "state", variables = "B25010_001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate) %>% rename("hh.size" = "estimate")



#combine acs income data with the max values of the income ranges, and average household size
HHincome_state.2 <- HHincome_state.1  %>% select(-moe) %>% left_join(y = inc.max.vals, by = c("variable" = "var"))  %>%
  mutate(acp_data = if_else(geoid %in% ACPstates$state_code, "y","n"),
    region = if_else(geoid == "02", "AK",
                if_else(geoid == "15", "HI", "L48"))) %>%
  left_join(y = HH.size_state, by = "geoid") %>%
 mutate(hh.size = if_else(is.na(hh.size) == TRUE, 2.60, hh.size), #for any places without an average household size, sets to the 2021 value (2.60)
   l48.fpl = (p148 + (p248*(hh.size - 1))), #creates fpl based on l48, ak, and hi values, then selects the appropriate value for "fpl"
                                     ak.fpl = (p1ak + (p2ak*(hh.size - 1))),
                                     hi.fpl = (p1hi + (p2hi*(hh.size - 1))),
                                     fpl = if_else(region == "L48", l48.fpl,
                                                   if_else(region == "AK", ak.fpl,hi.fpl))) %>%
  select(-ak.fpl, -hi.fpl, -l48.fpl, -region) %>%# removes the regional fpl values
  mutate(elig_200 = if_else(fpl >= max_income, "y","n")) %>% #denotes whether this income record includes eligible households
  subset(acp_data == "y" & variable != "B19001_001") %>% 
  subset(elig_200 == "y") %>% # retains only eligible income brackets and total # households
  select(geoid,name, estimate, hh.size, fpl) %>% group_by(geoid,name) %>%
  summarize(hh_qualify = sum(estimate))
                                                                                                                    
#join with total # households
HHincome_state.3 <- HHincome_state.2 %>% left_join(y = totalHH_state, by = "geoid") %>% #join with total # households
  left_join(y = ACPstates, by = c("geoid" = "state_code")) %>% #join with state-weekly enrollment data
  left_join(y = st_eligible, by = c("geoid" = "ST")) %>% #join with PUMS-derived eligibility
  mutate(HHqualify_perc = (hh_qualify/total_hh)*100, 
  HHEoE_perc = (HH_7aug23/hh_qualify)*100, ###NEED TO EDIT THIS ROW ANY TIME STATE DATA IS UPDATED###
  HH_eligiblePUMS = (hh_eligible/total_hh)*100,
  HHEoE_PUMSperc = (HH_7aug23/hh_eligible)*100,
  adj_factor = HHEoE_perc/HHEoE_PUMSperc) %>% 
  rename("totalHH"="total_hh", "HHqualify"="hh_qualify") %>%
  select(-name, -state) %>%
  select(geoid, State, totalHH, HHqualify, HHqualify_perc, HH_7aug23, HHEoE_perc,hh_eligible, HH_eligiblePUMS, HHEoE_PUMSperc, adj_factor) %>% 
  #subset(geoid != "69" & geoid != "66" & geoid != "60" & geoid != "72" & geoid != "78") %>%
  rename("state" = "State", "hh_PUMSeligible" = "hh_eligible") %>%
  ungroup() 

st <- states(cb = TRUE, year = 2021)
st_adj_factor <- st %>% left_join(y = HHincome_state.3, by = c("STATEFP" = "geoid")) %>%
  mutate(adj_factor = ifelse(is.na(adj_factor) == TRUE, 1, adj_factor))

#write this as individual file for github
#write.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_DASHBOARD_EnrollByState.csv", x = HHincome_state.3)

```

```{r ACP ZCTA Analysis, echo=FALSE, cache=TRUE, cache.lazy=FALSE, results='hide'}

#RESOURCES
#vars5 <- load_variables(2020, "acs5" ,cache = TRUE) #load ACS variables in the 5 yr dataset
#vars5subject <- load_variables(2020, "acs5/subject", cache = TRUE) #loads subject-table variables
#subscript.vars <- c("B28011_002","B28011_004", "B28011_008") #1. Has an internet subscription 2. Has a broadband internet subscription 3. no Internet access


#import the list of zcta's for AK and HI
ak.zcta <- zctas(cb = FALSE, year = 2010, state = 02) #load AK zcta's
hi.zcta <- zctas(cb = FALSE, year = 2010, state = 15) #load HI zcta's


#variables indicating the 1-person household 200% fpl value (p1xx), and the rate of change for each additional person (p2xx)
#https://aspe.hhs.gov/sites/default/files/private/aspe-files/107166/2021-percentage-poverty-tool_0.pdf
p148 <- 25760 
p248 <- 9080 #2 person FPL - 1 person FPL
p1ak <- 32180
p2ak <- 11360
p1hi <- 29640
p2hi <- 10440


#download household income data from acs
HHincome_zcta.1 <- get_acs(survey = "acs5", geography = "zcta", table = "B19001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names()  #download version without geography 

#download household income data from acs
totalHH_zcta <- get_acs(survey = "acs5", geography = "zcta", variables = "B19001_001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate,moe) %>% rename("total_hh" = "estimate") %>%  #download version without geography 
mutate(total_hh = ifelse(total_hh == 0, moe, total_hh)) %>% select(-moe)
  
#download average household size from acs
HH.size_zcta <- get_acs(survey = "acs5", geography = "zcta", variables = "B25010_001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate) %>% rename("hh.size" = "estimate")

#combine acs income data with the max values of the income ranges, and average household size
HHincome_zcta.2 <- HHincome_zcta.1  %>% select(-moe) %>% left_join(y = inc.max.vals, by = c("variable" = "var")) %>% 
  mutate(acp_data = if_else(geoid %in% acp_zip$zcta, "y","n"),
    region = if_else(geoid %in% ak.zcta$ZCTA5CE10, "AK",
                if_else(geoid %in% hi.zcta$ZCTA5CE10, "HI", "L48"))) %>%
  left_join(y = HH.size_zcta, by = "geoid") %>%
 mutate(hh.size = if_else(is.na(hh.size) == TRUE, 2.60, hh.size), #https://www.census.gov/quickfacts/fact/table/US/HCN010217 average HH size 2017-2021
   l48.fpl = (p148 + (p248*(hh.size - 1))), #creates fpl based on l48, ak, and hi values, then selects the appropriate value for "fpl"
                                     ak.fpl = (p1ak + (p2ak*(hh.size - 1))),
                                     hi.fpl = (p1hi + (p2hi*(hh.size - 1))),
                                     fpl = if_else(region == "L48", l48.fpl,
                                                   if_else(region == "AK", ak.fpl,hi.fpl))) %>%
  select(-ak.fpl, -hi.fpl, -l48.fpl, -region) %>%# removes the regional fpl values
  mutate(elig_200 = if_else(fpl >= max_income, "y","n")) %>% #denotes whether this income record includes eligible households
  subset(acp_data == "y" & variable != "B19001_001") %>% 
  subset(elig_200 == "y") %>% # retains only eligible income brackets and total # households
  select(geoid, estimate, hh.size, fpl) %>% group_by(geoid) %>% 
  summarize(hh_qualify = sum(estimate))


#join with total # households
HHincome_zcta.3 <- HHincome_zcta.2 %>% left_join(y = totalHH_zcta, by = "geoid") %>%
  mutate(HHqualify_perc = (hh_qualify/total_hh)*100) 



#write acp enrollment by zcta to gdb
acp.service <- acp_zip %>% select(zipcode,zcta,state, enrollments) %>%  
  subset(zipcode != "00000") %>% #removes the row with redacted zipcodes
  left_join(y = HHincome_zcta.3, by = c("zcta" = "geoid")) %>% 
  mutate(HHEoE_perc = (enrollments/hh_qualify*100)) %>% #calculate the percent of enrolled of eligible HH's
  rename("totalHH" = "total_hh") %>% 
  mutate(HHEoE_perc = ifelse(HHEoE_perc >= 100, 101,
                              ifelse(HHEoE_perc == Inf, 101,HHEoE_perc))) %>% #if % is greater than 100 or Inf, then set as 101 % 
  left_join(y = acp_zip_spent, by = "zipcode") %>%
  left_join(y = st_adj_factor[,c("STUSPS", "adj_factor")], by = c("state" = "STUSPS")) %>% 
  mutate(eligible_adj = hh_qualify*adj_factor, #add in adjusted calculations of eligibility
         eligible_adj_perc = (eligible_adj/totalHH)*100, 
         HHEoE_adj = (enrollments/eligible_adj)*100) %>%
  select(zipcode,zcta,state,totalHH, enrollments,eligible_adj, eligible_adj_perc, HHEoE_adj, total_support) %>% 
  #subset(is.na(enrollments) == FALSE & is.na(HHEoE_adj) == FALSE) %>%
  mutate(HHEoE_adj = ifelse(HHEoE_adj >= 100, 101,
                              ifelse(HHEoE_adj == Inf, 101,HHEoE_adj)),
         eligible_adj_perc = ifelse(eligible_adj_perc >= 100, 101, eligible_adj_perc),
         enrollments = ifelse(is.na(enrollments) == TRUE, 0, enrollments))

#write this as individual file for github
#write.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_DASHBOARD_EnrollByZip.csv", x = acp.service)


# #associate Benton's list of cities with respective states
# bentonFIPS <- benton %>% left_join(y = fips_states, by = "state")
# #arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/bentonFIPS2",data = bentonFIPS)
# 
#  ###START HERE TO UPDATE BENTON ZIP CODE DATA###
bentonzips <- arc.select(bentondata) %>%
  select(city, GEOID20) %>% rename("zipcode" = "GEOID20")


#creates dataset of only Benton cities for dashboard/github 
#groups the data by city and then summarizes to great city-level enrollment estimates (not averages)
ACP_Benton <- acp.service %>% right_join(y = bentonzips) %>% subset(is.na(city) == FALSE) %>% 
  select(city, enrollments, totalHH, eligible_adj, total_support) %>% group_by(city) %>%
  dplyr::summarize(enrollments = sum(na.omit(enrollments)), totalHH = sum(totalHH), hh_qualify_adj = sum(na.omit(eligible_adj)), total_support = sum(na.omit(total_support)),
            HHEoE_adj = (enrollments/hh_qualify_adj)*100) %>% st_drop_geometry()

ACP_Benton_sp <- usZIP %>% right_join(y = acp.service, by = c("GEOID20" = "zcta")) %>%
  right_join(bentonzips[,c("city","zipcode")], by = "zipcode")


##arcgisbinding::arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/ACP_Benton_sp2", data = ACP_Benton_sp, overwrite=TRUE)


# #write to git folder
# arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_DASHBOARD_Benton_7aug2023.shp", data = ACP_Benton_sp, overwrite = TRUE)


###edit this to try estimate from zip data
#total number of HHs in US
US_totalHH <- sum(na.omit(totalHH_zcta$total_hh))

#total number of HHs eligible in US
US_eligibleHH = sum(na.omit(HHincome_state.3$hh_PUMSeligible)) 

#percent of HH in US that are eligible
US_eligible_percent <- (US_eligibleHH/US_totalHH)*100

max.date <- max(acp_national$monthBYyear)

#total enrolled in US (current)
US_enrolled <- acp_national %>% subset(monthBYyear == max.date) %>% select(monthBYyear,allHH) 

#percent of eligible HH that are enrolled
US_HHEoE <- (US_enrolled$allHH/US_eligibleHH)*100

#percent of all HH that are enrolled
us_hheoALL <- (US_enrolled$allHH/US_totalHH)*100
```

```{r crosswalk zip code to congressional district, echo=FALSE}

#load zipcode to congressional district data from HUD crosswalk API

library(httr)
library(jsonlite)

# Return a data frame of HUD USPS Crosswalk values

url <- "https://www.huduser.gov/hudapi/public/usps?type=5&query=All&year=2021"
token <- Sys.getenv("HUD_API")
headers <- c("Authorization" = paste("Bearer", token))

response <- GET(url, add_headers(headers))

if (status_code(response) != 200) {
  print(paste("Failure, see status code:", status_code(response)))
} else {
  content <- content(response, "text")
  df <- fromJSON(content)$data$results
  print(df)
}

df <- df %>% mutate(geoid = ifelse(geoid == "1100", "1198", 
                                   ifelse(geoid == "7200", "7298", geoid))) 
```

```{r compile data for congressional districts, echo = FALSE}

#load congressional district -> zcta file (https://www2.census.gov/geo/docs/maps-data/data/rel2020/cd-sld/tab20_cd11820_zcta520_natl.txt)
# cdTOzcta <- read.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/PUMS_5yr_2021/cdTOzcta.txt") %>% clean_names() %>%
#   mutate(geoid_zcta5_20 = as.character(geoid_zcta5_20))
# 
# #make sure all zipcodes have leading zeros & convert to character
# cdTOzcta$geoid_zcta5_20 <-  str_pad(cdTOzcta$geoid_zcta5_20, width = 5, side = c("left"), pad = 0)
# 
# #create spending summary of zcta claims data
# acp_zip_spent2 <- acp_zip_spent %>% group_by(zipcode) %>% summarize(total_spent = sum(total_support)) %>% subset(zipcode != "00000")
# cd116 <- congressional_districts(state = NULL, year = 2020)
# arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/cd116", data = cd116)


#load cd116 - cd188 conversion file (created from geocorr using 2020 housing units as weight)
#https://mcdc.missouri.edu/applications/geocorr2022.html
cd116TO118 <- read.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/CrosswalkData/geocorr2022_2314307406.csv", header = TRUE) %>%
  clean_names() 
cd116TO118 <- cd116TO118[-1,]

cd116TO118 <- cd116TO118 %>% mutate(cd116 = paste(state,cd116, sep = ""), cd118 = paste(state,cd118, sep = ""), afact = as.numeric(afact))

#load congressional district (118th) data from USAC's ACP-Funding-Summary-by-Geography file
cd_data <- read_excel("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP-Funding-Summary-by-Geography.xlsx", sheet = "CD_MAY") %>% clean_names()

cd_data$cd <-  str_pad(cd_data$cd, width = 2, side = c("left"), pad = 0)
state_code <- fips_states$state_code
cd <- cd_data$cd
cd_data_all <- cd_data %>% left_join(y = fips_states, by = "state") %>% 
  mutate(district = paste0(state_code,cd), district = ifelse(district %like% "NA", paste(state,"ZZ"), district)) #%>%
  #rename("total_support" = "total_claim_amount")

#import the list of zcta's for AK and HI
ak.cd <- congressional_districts(cb = FALSE, state = 02, year = 2022) #load AK zcta's
hi.cd <- congressional_districts(cb = FALSE, state = 15) #load HI zcta's


#variables indicating the 1-person household 200% fpl value (p1xx), and the rate of change for each additional person (p2xx)
#https://aspe.hhs.gov/sites/default/files/private/aspe-files/107166/2021-percentage-poverty-tool_0.pdf
p148 <- 25760 
p248 <- 9080 #2 person FPL - 1 person FPL
p1ak <- 32180
p2ak <- 11360
p1hi <- 29640
p2hi <- 10440


#download household income data from acs
HHincome_cd.1 <- get_acs(survey = "acs5", geography = "congressional district", table = "B19001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names()  #download version without geography 

#download household income data from acs
totalHH_cd <- get_acs(survey = "acs5", geography = "congressional district", variables = "B19001_001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate,moe) %>% rename("total_hh" = "estimate") %>%  #download version without geography 
mutate(total_hh = ifelse(total_hh == 0, moe, total_hh)) %>% select(-moe)
  
#download average household size from acs
HH.size_cd <- get_acs(survey = "acs5", geography = "congressional district", variables = "B25010_001", year = 2021, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate) %>% rename("hh.size" = "estimate")

#combine acs income data with the max values of the income ranges, and average household size
HHincome_cd.2 <- HHincome_cd.1  %>% select(-moe) %>% left_join(y = inc.max.vals, by = c("variable" = "var")) %>% 
  mutate(region = if_else(geoid %in% ak.cd$GEOID, "AK",
                if_else(geoid %in% hi.cd$GEOID, "HI", "L48"))) %>%
  left_join(y = HH.size_cd, by = "geoid") %>%
 mutate(hh.size = if_else(is.na(hh.size) == TRUE, 2.60, hh.size), #https://www.census.gov/quickfacts/fact/table/US/HCN010217 average HH size 2017-2021
   l48.fpl = (p148 + (p248*(hh.size - 1))), #creates fpl based on l48, ak, and hi values, then selects the appropriate value for "fpl"
                                     ak.fpl = (p1ak + (p2ak*(hh.size - 1))),
                                     hi.fpl = (p1hi + (p2hi*(hh.size - 1))),
                                     fpl = if_else(region == "L48", l48.fpl,
                                                   if_else(region == "AK", ak.fpl,hi.fpl))) %>%
  select(-ak.fpl, -hi.fpl, -l48.fpl, -region) %>%# removes the regional fpl values
  mutate(elig_200 = if_else(fpl >= max_income, "y","n")) %>% #denotes whether this income record includes eligible households
  subset(variable != "B19001_001") %>% 
  subset(elig_200 == "y") %>% # retains only eligible income brackets and total # households
  select(geoid, estimate, hh.size, fpl) %>% group_by(geoid) %>% 
  summarize(hh_qualify = sum(estimate))


#join with total # households
HHincome_cd.3 <- HHincome_cd.2 %>% left_join(y = totalHH_cd, by = "geoid") 


#--------------join with zcta acp data to get most recent enrollment data (116th?)
#join zcta acp data
ACP_zip2cd <- HHincome_cd.3  %>%
  left_join(y = df[,c("zip","geoid","res_ratio")], by = "geoid") %>% 
  left_join(y = acp_zip[,c("zipcode","enrollments")], by = c("zip" = "zipcode")) %>%
  left_join(y = acp_zip_spent, by = c("zip" = "zipcode")) %>%
  mutate(cd_enrolled = res_ratio*enrollments) %>%
  select(geoid, cd_enrolled) %>% group_by(geoid) %>% summarize(enrollments = sum(na.omit(cd_enrolled)))



#-------------join with new congressional data to get cd-level spent data
#join conversion file created in ArcGIS with eligibility data (116) and enrollment/claims data (118)
ACP_116to118cd <- cd116TO118  %>% 
 left_join(y = HHincome_cd.3, by = c("cd116" = "geoid")) %>%  #join conversion file with eligibility data derived from ACS (116th)
  left_join(y = ACP_zip2cd, by = c("cd116" = "geoid")) %>%
  mutate(hh_qualify = afact*hh_qualify, total_hh = afact*total_hh, enrollments = afact*enrollments) %>% ungroup() %>%
  select(cd118, state, stab, total_hh, hh_qualify, enrollments) %>% 
  group_by(cd118, state, stab) %>%
  summarize(hh_qualify = sum(na.omit(hh_qualify)), total_hh = sum(na.omit(total_hh)), enrollments = sum(na.omit(enrollments))) %>%
  left_join(y = st_adj_factor[,c("STUSPS", "adj_factor")], by = c("stab" = "STUSPS")) %>% #join with state-level adjustment factor
  mutate(hh_qualify = na.omit(hh_qualify)*adj_factor) %>% #add in adjusted calculations of eligibility
  select(state, stab, cd118, total_hh, hh_qualify, enrollments) %>% 
  rename("state_code" = "state","state" = "stab", "district" = "cd118") %>% mutate(dist_code = substr(district, 3,4))
  
ACP_cd <- ACP_116to118cd %>% full_join(y = cd_data_all, by = c("district", "state_code", "state", "dist_code" = "cd")) %>% #join with enrollment/claims data
  mutate(percent_eligible = (hh_qualify/total_hh)*100,
         HHEoE = (enrollments/hh_qualify)*100,
         #enrollments = ifelse(is.na(enrollments) == TRUE, 0, enrollments),
         total_support = ifelse(is.na(total_support) == TRUE, 0, total_support)) %>% 
  mutate(HHEoE = ifelse(HHEoE > 100, 101,
                              ifelse(HHEoE == Inf, 101,HHEoE)),
         percent_eligible = ifelse(percent_eligible > 100, 101, percent_eligible))
         #enrollments = ifelse(is.na(enrollments) == TRUE, 0, enrollments)) 

#summarize zip data within districts
# ACP_cd <- ACP_zip2cd %>% 
#   mutate(hh_qualify = adj_factor*hh_qualify,cd_enrolled = res_ratio*enrollments, cd_support = res_ratio*total_support) %>%
#   select(geoid, state, total_hh,hh_qualify, cd_enrolled,cd_support) %>%
#   group_by(geoid, state, total_hh, hh_qualify) %>%
#   dplyr::summarise(enrollments = sum(na.omit(cd_enrolled)), total_support = sum(na.omit(cd_support))) %>%
#   mutate(percent_eligible = (hh_qualify/total_hh)*100,
#          HHEoE = (enrollments/hh_qualify)*100,
#          enrollments = ifelse(is.na(enrollments) == TRUE, 0, enrollments),
#          total_support = ifelse(is.na(total_support) == TRUE, 0, total_support)) %>% ungroup() %>% 
#   #subset(is.na(enrollments) == FALSE & is.na(HHEoE_adj) == FALSE) %>%
#   mutate(HHEoE = ifelse(HHEoE >= 100, 101,
#                               ifelse(HHEoE == Inf, 101,HHEoE)),
#          percent_eligible = ifelse(percent_eligible >= 100, 101, percent_eligible),
#          enrollments = ifelse(is.na(enrollments) == TRUE, 0, enrollments)) %>% mutate(district = substr(geoid, 3,4)) 


#load in legislature dataset from here: https://github.com/unitedstates/congress-legislators
legislators.118 <- read.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/Congress/legislators-118.csv")
#make sure all districts have leading zeros & convert to character
legislators.118$district <-  str_pad(legislators.118$district, width = 2, side = c("left"), pad = 0)
legislators.118$district <- as.character(legislators.118$district)
legislators_188_simple <- legislators.118 %>% select(state, district, last_name, first_name, party, url, phone) 

ACP_cd_info <- legislators_188_simple %>% left_join(y = ACP_cd, by = c("state", "district" = "dist_code")) #add this dataset to ACP_DASHBOARD_V2 (ACP_cd_infoSP gets used for map)



#write to arcgis to join with cd spatial & write as shp to data folder (don't use tigris, unless it changes to 118)
#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/ACP_CD7aug23", data = ACP_cd_info, overwrite = TRUE)

# #write to git folder
# arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_CD7aug23.shp", data = ACP_cd_info, overwrite = TRUE)

#write this as individual file for github
#write.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_DASHBOARD_EnrollByCD.csv", x = ACP_cd_info)

```

```{r enrollment model ,cache = TRUE,cache.lazy = FALSE, echo=FALSE}

#continuous growth model - simple regression based on observed enrollment through 16 Jan 2023


#data includes growth observed during EBB program to better inform the model
acp_mod1 <- lm(allHH ~ monthBYyear, data = acp_national) 
glance(acp_mod1)#summary details of the model

#predict total spent to 240 months past Mar 2022
acp_predict1 <- predict.lm(acp_mod1, newdata = future, se.fit = TRUE, level = .95, interval = "prediction") 



enrolled <- max(US_enrolled$allHH)


##calculate #HH for % enrollment caps

#enrollment cap based on current enrollment
US_eligibleHH.current <- US_eligibleHH*(US_HHEoE/100) %>% as.numeric()
#30% of HHs that qualify for ACP and enroll
US_eligibleHH30 <- US_eligibleHH*.30
#35% of HHs that qualify for ACP and enroll
US_eligibleHH35 <- US_eligibleHH*.35
#40% of HHs that qualify for ACP and enroll
US_eligibleHH40 <- US_eligibleHH*.40
#45% of HHs that qualify for ACP and enroll
US_eligibleHH45 <- US_eligibleHH*.45
#50% of HHs that qualify for ACP and enroll
US_eligibleHH50 <- US_eligibleHH*.5
#55% of HHs that qualify for ACP and enroll
US_eligibleHH55 <- US_eligibleHH*.55
#60% of HHs that qualify for ACP and enroll
US_eligibleHH60 <- US_eligibleHH*.60
#75% of HHs that qualify for ACP and enroll
US_eligibleHH75 <- US_eligibleHH*.75

#create index which represents months - currently predicting Mar 2023 and beyond
acp_ToPlot1 <- data.frame(acp_predict1$fit) %>% mutate(monthBYyear = 29:238) %>% rename(enrolled = fit)

#create ACP-only vector (selects only months after switch from EBB to ACP)
ACP.only <- acp_national %>% subset(monthBYyear >= 9) %>% select(monthBYyear,month, allHH) %>% rename(enrolled = allHH)

ebb.acp <- 1257588871 + 14200000000 #remaining amount of EBB fund + full ACP fund

#calculates amount of fund used with enrollment remaining at current percent of eligible HH
x <- round(US_HHEoE,0)
y <- round((US_eligibleHH.current/1000000), 1)
enroll.current <- acp_ToPlot1 %>% subset(enrolled <  US_eligibleHH.current) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll.currentb <- enroll.current %>% bind_rows(enroll.current[rep(nrow(enroll.current), 36),] %>%
              mutate(month = month + seq(36))) %>% #creates a month sequence, to project out to 36 months
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent), #estimates monthly spent (based only on enrollment & cumulative spent)
                     perc.enrolled = (enrolled/US_eligibleHH)*100 , perc.used = (cum.spent/ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 56)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25/ebb.acp)*100, #adds in an extra 2.5% that Ry suggested to incorporate higher tribal value and device spending
         model = paste0(x, " Percent Enrollment" ," (",y," Million Households)"))
enroll.currentb$month  <- format(enroll.currentb$month, format = "%b-%y") #pastes dynamic label for Tableau display

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll_current",colNames = TRUE, overwrite = TRUE, x = enroll.currentb)

###STEP A
# add.in35 <- data.frame("enrolled" = US_eligibleHH35,"lwr" = NA, "upr" = NA, "month" = (max(ACP.only$month) + 1)) 
# enroll35 <- ACP.only %>%  bind_rows(add.in35) %>%  as.data.frame() %>% arrange(monthBYyear)
# enroll35b <- enroll35 %>% bind_rows(enroll35[rep(nrow(enroll35), 36),] %>%
#               mutate(month = month + seq(36))) %>% 
#               mutate(lwr = NA, upr = NA,
#                      month.spent = enrolled*30, 
#                      cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/US_eligibleHH)*100,
#                      perc.used = (cum.spent/ebb.acp)*100,
#                      month = seq(as.Date("2022-01-01"), by = "month",length.out = 53)) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "35 Percent Enrollment (18.3 Million Households)")
# enroll35b$month <- format(enroll35b$month, format = "%b-%y")
# 
# #xlsx::write.xlsx("G:/My Drive/ACPdashboard/ACP_DASHBOARD.xlsx", sheetName = "SpotCheck", x = enroll.currentb, append = TRUE)
# #arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/enroll35", data = enroll35b)
# 
# #calculates amount of fund used until %35 enrollment is observed
# enroll35 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH35) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
# enroll35b <- enroll35 %>% bind_rows(enroll35[rep(nrow(enroll35), 36),] %>%
#               mutate(month = month + seq(36))) %>%
#               mutate(month.spent = enrolled*30, 
#                      cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/US_eligibleHH)*100, 
#                      perc.used = (cum.spent /ebb.acp)*100,
#                      month = seq(as.Date("2022-01-01"), by = "month",length.out = 54)) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "35 Percent Enrollment (18.3 Million Households)")
# enroll35b$month <- format(enroll35b$month, format = "%b-%y")


#calculates amount of fund used until %40 enrollment is observed
#summary(acp_ToPlot1$enrolled < US_eligibleHH40) #test to determine if any predicted values fall under enrollment cap. If TRUE, then go to step B, if FALSE go to step A.
###STEP A
# add.in40 <- data.frame("enrolled" = US_eligibleHH40,"lwr" = NA, "upr" = NA, "month" = (max(ACP.only$month) + 1)) 
# enroll40 <- ACP.only %>%  bind_rows(add.in40) %>%  as.data.frame() %>% arrange(monthBYyear)
# enroll40b <- enroll40 %>% bind_rows(enroll40[rep(nrow(enroll40), 36),] %>%
#               mutate(month = month + seq(36))) %>% 
#               mutate(lwr = NA, upr = NA,
#                      month.spent = enrolled*30, 
#                      cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/US_eligibleHH)*100,
#                      perc.used = (cum.spent/ebb.acp)*100,
#                      month = seq(as.Date("2022-01-01"), by = "month",length.out = 52)) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "40 Percent Enrollment (20.8 Million Households)")
# enroll40b$month <- format(enroll40b$month, format = "%b-%y")

###STEP B
enroll40 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH40) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll40b <- enroll40 %>% bind_rows(enroll40[rep(nrow(enroll40), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, 
                     cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100, 
                     perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 56)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "40 Percent Enrollment (20.8 Million Households)")
enroll40b$month <- format(enroll40b$month, format = "%b-%y")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll40",colNames = TRUE, append = TRUE, x = enroll40b)

#calculates amount of fund used until %45 enrollment is observed


###STEP A
# add.in45 <- data.frame("enrolled" = US_eligibleHH45,"lwr" = NA, "upr" = NA, "month" = (max(ACP.only$month) + 1)) 
# enroll45 <- ACP.only %>%  bind_rows(add.in45) %>%  as.data.frame() %>% arrange(monthBYyear)
# enroll45b <- enroll45 %>% bind_rows(enroll45[rep(nrow(enroll45), 36),] %>%
#               mutate(month = month + seq(36))) %>% 
#               mutate(lwr = NA, upr = NA,
#                      month.spent = enrolled*30, 
#                      cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/US_eligibleHH)*100,
#                      perc.used = (cum.spent/ebb.acp)*100,
#                      month = seq(as.Date("2022-01-01"), by = "month",length.out = 51)) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "45 Percent Enrollment (23.5 Million Households)")
# enroll45b$month <- format(enroll45b$month, format = "%b-%y")

enroll45 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH45) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll45b <- enroll45 %>% bind_rows(enroll45[rep(nrow(enroll45), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 60)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "45 Percent Enrollment (23.5 Million Households)") 
enroll45b$month <- format(enroll45b$month, format = "%b-%y")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll45",colNames = TRUE, append = TRUE, x = enroll45b)

###STEP A
# add.in50 <- data.frame("enrolled" = US_eligibleHH50,"lwr" = NA, "upr" = NA, "month" = (max(ACP.only$month) + 1)) 
# enroll50 <- ACP.only %>%  bind_rows(add.in50) %>%  as.data.frame() %>% arrange(monthBYyear)
# enroll50b <- enroll50 %>% bind_rows(enroll50[rep(nrow(enroll50), 36),] %>%
#               mutate(month = month + seq(36))) %>% 
#               mutate(lwr = NA, upr = NA,
#                      month.spent = enrolled*30, 
#                      cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/US_eligibleHH)*100,
#                      perc.used = (cum.spent/ebb.acp)*100,
#                      month = seq(as.Date("2022-01-01"), by = "month",length.out = 51)) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "50 Percent Enrollment (26.1 Million Households)")
# enroll50b$month <- format(enroll50b$month, format = "%b-%y")

#calculates amount of fund used until %50 enrollment is observed
enroll50 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH50) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll50b <- enroll50 %>% bind_rows(enroll50[rep(nrow(enroll50), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 64)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "50 Percent Enrollment (26.1 Million Households)") 
enroll50b$month <- format(enroll50b$month, format = "%b-%y")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll50",colNames = TRUE, append = TRUE, x = enroll50b)

#calculates amount of fund used until %55 enrollment is observed
enroll55 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH55) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll55b <- enroll55 %>% bind_rows(enroll55[rep(nrow(enroll55), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 68)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "55 Percent Enrollment (28.7 Million Households)") 
enroll55b$month <- format(enroll55b$month, format = "%b-%y")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll55",colNames = TRUE, append = TRUE, x = enroll55b)

#calculates amount of fund used until %60 enrollment is observed
enroll60 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH60) %>% bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll60b <- enroll60 %>% bind_rows(enroll60[rep(nrow(enroll60), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 73)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "60 Percent Enrollment (31.3 Million Households)") 
enroll60b$month <- format(enroll60b$month, format = "%b-%y")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll60",colNames = TRUE, append = TRUE, x = enroll60b)

#calculates amount of fund used under continuous enrollment is observed 
enroll75 <- acp_ToPlot1 %>%  bind_rows(ACP.only) %>% arrange(monthBYyear) 
enroll75b <- enroll75 %>% bind_rows(enroll75[rep(nrow(enroll75), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 266)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "Continuous Enrollment Growth (no limit)") %>% subset(perc.enrolled < 100)
enroll75b$month <- format(enroll75b$month, format = "%b-%y")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           #sheetName = "enroll75",colNames = TRUE, append = TRUE, x = enroll75b)



modeldata <- bind_rows(enroll.currentb,
                       #enroll35b,
                       enroll40b,
                       enroll45b,
                       #enroll50b,
                       #enroll55b,
                       #enroll60b,
                       enroll75b) %>%
  mutate(m.seq = ave(perc.used25, model, FUN = seq_along))

p <- modeldata$cum.spent25/ebb.acp
z <- 1.96
q <- 1 - p
se <- sqrt((p*q)/ebb.acp)
CI <- z*se
modeldataCI <- modeldata %>% mutate(upperCI = (p + CI), lowerCI = (p - CI)) %>% select(-m.seq)


plot <- ggplot(modeldata, aes(x = m.seq, y = p, group=model)) +
   #xlim("Jan-21","Feb-26") +
   #ylim(0,1.5) +
  geom_line(aes(colour=model)) + theme_classic() +geom_hline(yintercept = 1) 

acpTESTplot <- plotly::ggplotly(plot) #converts plot to interactive version


#write.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_DASHBOARD_ModelData.csv", x = modeldata)
```

```{r create dashboard workbook}
wb <- loadWorkbook("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP_DASHBOARD_V2.xlsx")

#load in state data
addWorksheet(wb, "EnrollByState")
writeData(wb, "EnrollByState", HHincome_state.3)

#load in Benton data
addWorksheet(wb, "BentonCitiesData")
writeData(wb, "BentonCitiesData", ACP_Benton)

#load in model data
addWorksheet(wb, "ModelData")
writeData(wb, "ModelData", modeldata)

#load in zipcode data
addWorksheet(wb, "EnrollByZipcode")
writeData(wb, "EnrollByZipcode", acp.service)

#congressional data
addWorksheet(wb, "EnrollByCD")
writeData(wb, "EnrollByCD", ACP_cd_info)

saveWorkbook(wb,"C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP_DASHBOARD_V2.xlsx",overwrite = TRUE)

#write zipcode shapefile
acp.zip.sp <- usZIP[,c("GEOID20", "geometry")] %>% left_join(y = acp.service, by = c("GEOID20" = "zcta"))
arc.write("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/ACP_ZipData_7aug.shp", data = acp.zip.sp, overwrite = TRUE) #may need to edit in future to ACP_ZipStateCD_geo

total_support <- sum(na.omit(claims22_23$total_support))

#write state boundary shapefile
#states <- arc.open("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/USA_StateBoundaries.shp") %>% arc.select() %>%
#arc.write("C:/Users/chris/Dropbox (ILSR)/CBN Team Folder/Resources/Resources/Affordable Connectivity Program/Dashboard Data/US_StateBoundaries.shp", data = states)
```  

```{r create workbook pineapple}

HHincome_state.3b <- HHincome_state.3 %>% mutate(estimated_spent = HH_7aug23*30*1.025) %>% 
   rename("perc_eligible" = "HH_eligiblePUMS", "perc_EoE" = "HHEoE_PUMSperc") %>%
  select(-HHqualify, -HHqualify_perc, -HHEoE_perc) 

wb <- loadWorkbook("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_QuickFactsData_7aug23.xlsx")

#load in state data
addWorksheet(wb, "EnrollByState")
writeData(wb, "EnrollByState", HHincome_state.3b)


#congressional data
addWorksheet(wb, "EnrollByCD")
writeData(wb, "EnrollByCD", ACP_cd_info)


saveWorkbook(wb,"C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACP_QuickFactsData_7aug23.xlsx",overwrite = TRUE)




```

