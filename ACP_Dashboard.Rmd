---
title: "ACP Enrollment Dashboard"
author: "Christine Parker | ILSR"
date: "26 Aug 2022"

---

```{r setup, include = FALSE, echo=FALSE}

library(tidyverse)
library(tidycensus)
census_api_key(Sys.getenv("CENSUS_API_KEY"))
library(stringr)
library(arcgisbinding)
arc.check_product()
library(gt)
library(extrafont)
library(rvest)
library(janitor)
library(RSocrata)
library(dplyr)
library(readr)
library(usdata)
library(tinytex)
library(scales)
library(readxl)
library(arsenal)
library(lubridate)
library(broom)
library(openxlsx)
library(tigris)
library(tidyverse)
library(rgdal)
library(maptools)
library(mapproj)
library(rgeos)
library(tigris)
library(sf)
library(plotly)
library(htmlwidgets)

#Options-------------------
options(scipen = 999)
options(digits = 1)
options(tigris_use_cache = TRUE)
```

```{r Load Data, echo=FALSE, cache=TRUE, cache.lazy=FALSE, results='hide'}
#load ACP enrollment data from spreadsheet (manually updated each week)
#edit the variable name to reflect the most recent data update
ACP22aug <- "G:/My Drive/ACPdashboard/ACPWeeklyEnroll.xlsx"

data(fips_codes) #creates dataframe of all state and county fips codes
fips_states <- fips_codes %>% select(state_name,state,state_code) 
fips_states <- distinct(fips_states) #condense down to single row per state

##loads enrollment by zipcode data (this dataset does not include subscription vs. device & claims details)
acp_zcta <- read_excel("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/ACP/ACP-Enrollments-by-Zip-Code-as-of-July-1.xlsx", sheet = 1, col_names = TRUE) %>% clean_names() 

ACPstates <-read_excel(path = ACP22aug, sheet = 4, col_names = TRUE) %>%
  select(State,HH_aug22)%>% 
  left_join(y = fips_states, by = c("State" = "state_name"))


#read in benton cities and add in the FIPS numbers to enable join in GIS
benton <- read.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/RawData/ACP/BentonCities.xlsx", sheet = 1)

#read in the Benton zipcode list
bentondata <- arc.open("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/BentonCitiesZipcodesNames")

#Total number of households (HHs) that fall within 200% of the poverty line defined by US. Dept of Health & Human Services https://aspe.hhs.gov/topics/poverty-economic-mobility/poverty-guidelines/prior-hhs-poverty-guidelines-federal-register-references/2019-poverty-guidelines#guidelines
 #load in this spreadsheet which contains the max value for each range of household income
inc.max.vals <- read.csv("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Dashboard/acs_HH_max_income_range.csv")

#load in zcta data for mapping
usZIP <- zctas(cb = TRUE, year = 2019)

#NATIONAL DATA
acp_national <-read_excel(path = ACP22aug, sheet = 2, col_names = TRUE) %>% clean_names() %>%
  #summarize data by year and month - total households, broken down into tribal and non-tribal
  group_by(month(date), year(date)) %>% summarize(allHH = max(total_households), ntHH = max(non_tribal), tHH = max(tribal)) %>% 
  #estimate how much of the fund has been used so far - using tribal and non-tribal HH enrollment
  mutate(nt_fund = ntHH*30, t_fund = tHH*75) %>%
  #total fund use so far & create new year & month columns to be able to arrange...
  mutate(TotalUsed = nt_fund + t_fund, TotalUsed2.5 = TotalUsed*1.25) %>% rename(month = 'month(date)', year = 'year(date)') %>% arrange(year, month) %>% mutate(CumUsed2.5 = cumsum(TotalUsed2.5))
  #and create a month index value to use in the analysis
   acp_national$monthBYyear <- 1:nrow(acp_national)
   
   
   
#numerical list of months to use in prediction formula below (need to change this after June)
future <- data.frame(monthBYyear = c(15:240))

```

```{r ACP ZCTA Analysis, echo=FALSE, cache=TRUE, cache.lazy=FALSE, results='hide'}

#RESOURCES
#vars5 <- load_variables(2020, "acs5" ,cache = TRUE) #load ACS variables in the 5 yr dataset
#vars5subject <- load_variables(2020, "acs5/subject", cache = TRUE) #loads subject-table variables
#subscript.vars <- c("B28011_002","B28011_004", "B28011_008") #1. Has an internet subscription 2. Has a broadband internet subscription 3. no Internet access


#make sure all zipcodes have leading zeros & convert to character
acp_zcta$zipcode <-  str_pad(acp_zcta$zipcode, width = 5, side = c("left"), pad = 0)
acp_zcta$zipcode <- as.character(acp_zcta$zipcode)


#import the list of zcta's for AK and HI
ak.zcta <- zctas(cb = FALSE, year = 2010, state = 02) #load AK zcta's
hi.zcta <- zctas(cb = FALSE, year = 2010, state = 15) #load HI zcta's


#variables indicating the 1-person household 200% fpl value (p1xx), and the rate of change for each additional person (p2xx)
#https://aspe.hhs.gov/topics/poverty-economic-mobility/poverty-guidelines/prior-hhs-poverty-guidelines-federal-register-references/2019-poverty-guidelines
p148 <- 24980
p248 <- 8840
p1ak <- 31200
p2ak <- 11060
p1hi <- 28760
p2hi <- 10160


#download household income data from acs
HHincome_zcta.1 <- get_acs(survey = "acs5", geography = "zcta", table = "B19001", year = 2019, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names()  #download version without geography 

#download household income data from acs
totalHH_zcta <- get_acs(survey = "acs5", geography = "zcta", variables = "B19001_001", year = 2019, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate,moe) %>% rename("total_hh" = "estimate") %>%  #download version without geography 
mutate(total_hh = ifelse(total_hh == 0, moe, total_hh)) %>% select(-moe)
  
#download average household size from acs
HH.size_zcta <- get_acs(survey = "acs5", geography = "zcta", variables = "B25010_001", year = 2019, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate) %>% rename("hh.size" = "estimate")

#combine acs income data with the max values of the income ranges, and average household size
HHincome_zcta.2 <- HHincome_zcta.1  %>% select(-moe) %>% left_join(y = inc.max.vals, by = c("variable" = "var")) %>% 
  mutate(acp_data = if_else(geoid %in% acp_zcta$zipcode, "y","n"),
    region = if_else(geoid %in% ak.zcta$ZCTA5CE10, "AK",
                if_else(geoid %in% hi.zcta$ZCTA5CE10, "HI", "L48"))) %>%
  left_join(y = HH.size_zcta, by = "geoid") %>%
 mutate(hh.size = if_else(is.na(hh.size) == TRUE, 2.62, hh.size),
   l48.fpl = (p148 + (p248*(hh.size - 1))), #creates fpl based on l48, ak, and hi values, then selects the appropriate value for "fpl"
                                     ak.fpl = (p1ak + (p2ak*(hh.size - 1))),
                                     hi.fpl = (p1hi + (p2hi*(hh.size - 1))),
                                     fpl = if_else(region == "L48", l48.fpl,
                                                   if_else(region == "AK", ak.fpl,hi.fpl))) %>%
  select(-ak.fpl, -hi.fpl, -l48.fpl, -region) %>%# removes the regional fpl values
  mutate(elig_200 = if_else(fpl >= max_income, "y","n")) %>% #denotes whether this income record includes eligible households
  subset(acp_data == "y" & variable != "B19001_001") %>% 
  subset(elig_200 == "y") %>% # retains only eligible income brackets and total # households
  select(geoid, estimate, hh.size, fpl) %>% group_by(geoid) %>%
  summarize(hh_qualify = sum(estimate))

#LISC VERSION####combine acs income data with the max values of the income ranges, and average household size
# p148 <- 27180
# p248 <- 9440
# p1ak <- 27180
# p2ak <- 9440
# p1hi <- 27180
# p2hi <- 9440
# HHincome_zcta.2 <- HHincome_zcta.1  %>% select(-moe) %>% left_join(y = inc.max.vals, by = c("variable" = "var")) %>%
#   mutate(acp_data = if_else(geoid %in% acp_zcta$zipcode, "y","n"),
#     region = if_else(geoid %in% ak.zcta$ZCTA5CE10, "AK",
#                 if_else(geoid %in% hi.zcta$ZCTA5CE10, "HI", "L48"))) %>%
#   left_join(y = HH.size_zcta, by = "geoid") %>%
#  mutate(hh.size = if_else(is.na(hh.size) == TRUE, 2.62, hh.size),
#    l48.fpl = (p148 + (p248*(hh.size - 1))), #creates fpl based on l48, ak, and hi values, then selects the appropriate value for "fpl"
#                                      ak.fpl = (p1ak + (p2ak*(hh.size - 1))),
#                                      hi.fpl = (p1hi + (p2hi*(hh.size - 1))),
#                                      fpl = if_else(region == "L48", l48.fpl,
#                                                    if_else(region == "AK", ak.fpl,hi.fpl))) %>%
#   select(-ak.fpl, -hi.fpl, -l48.fpl, -region) %>%# removes the regional fpl values
#   mutate(elig_200 = if_else(fpl >= max_income, "y","n")) %>% #denotes whether this income record includes eligible households
#   subset(acp_data == "y" & variable != "B19001_001") %>%
#   subset(elig_200 == "y") %>% # retains only eligible income brackets and total # households
#   select(geoid, estimate, hh.size, fpl) %>% group_by(geoid) %>%
#   summarize(hh_qualify = sum(estimate))
                                                                                                                    
#join with total # households
HHincome_zcta.3 <- HHincome_zcta.2 %>% left_join(y = totalHH_zcta, by = "geoid") %>%
  mutate(HHqualify_perc = (hh_qualify/total_hh)*100) 



data(fips_codes) #creates dataframe of all state and county fips codes
fips_states <- fips_codes %>% select(state,state_code) 
fips_states <- distinct(fips_states) #condense down to single row per state

#associate Benton's list of cities with respective states
bentonFIPS <- benton %>% left_join(y = fips_states, by = "state")
#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/bentonFIPS2",data = bentonFIPS)

 ###START HERE TO UPDATE BENTON ZIP CODE DATA###
bentonzips <- arc.select(bentondata) %>%
  select(city, GEOID20) %>% rename("zipcode" = "GEOID20")



#write acp enrollment by zcta to gdb
acp.service <- acp_zcta %>% select(zipcode, enrollments) %>% 
  subset(zipcode != "00000") %>% #removes the row with redacted zipcodes
  left_join(y = HHincome_zcta.3, by = c("zipcode" = "geoid")) %>% 
  mutate(HHEoE_perc = (enrollments/hh_qualify*100)) %>% #calculate the percent of enrolled of eligible HH's
  rename("totalHH" = "total_hh") %>% 
  mutate(HHEoE_perc = ifelse(HHEoE_perc >= 100, 101,
                              ifelse(HHEoE_perc == Inf, 101,HHEoE_perc))) #if % is greater than 100 or Inf, then set as 101 %

#edited this (Aug 16) to include only Benton cities in dataset for dashboard 
#groups the data by city and then summarizes to great city-level enrollment estimates (not averages)
acp.serviceBenton1 <- acp.service %>% left_join(y = bentonzips, by = "zipcode") %>% subset(is.na(city) == FALSE) %>% select(city, enrollments, totalHH, hh_qualify) %>% group_by(city) %>%
  dplyr::summarize(enrollments = sum(enrollments), totalHH = sum(totalHH), hh_qualify = sum(hh_qualify),
            HHEoE_perc = (enrollments/hh_qualify)*100) %>% rename("HHqualify" = "hh_qualify")


###edit this to try estimate from zip data
#total number of HHs in US
US_totalHH <- sum(totalHH_zcta$total_hh)

#total number of HHs eligible in US
US_eligibleHH = sum(HHincome_zcta.3$hh_qualify) 

#percent of HH in US that are eligible
US_eligible_percent <- (US_eligibleHH/US_totalHH)*100

max.date <- max(acp_national$monthBYyear)

#total enrolled in US (current)
US_enrolled <- acp_national %>% subset(monthBYyear == max.date) %>% select(monthBYyear,allHH) 

#percent of eligible HH that are enrolled
US_HHEoE <- (US_enrolled$allHH/US_eligibleHH)*100

#this version of acp.serviceBenton includes all zipcode data to be written to the ACP geodb in ArcGIS, projected, and then exported as a .shp.
acp.serviceBenton2 <- acp.service %>% left_join(y = bentonzips, by = "zipcode")

#WRITE TO ACP DASHBOARD FOLDER  
write.xlsx("G:/My Drive/ACPdashboard/ACP_DASHBOARD.xlsx", sheetName = "BentonCitiesData", x = acp.serviceBenton1, overwrite = TRUE)



ACPzipBenton <- usZIP %>% left_join(y = acp.serviceBenton2, by = c("GEOID10" = "zipcode"))
arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/ACP_ZipBenton26AUG2022", data = ACPzipBenton, overwrite = TRUE)

#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/ZipBounds", data = usZIP)


#----------------------------
#rescale and shift AK and HI

zip <- readOGR(dsn = "C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb",
           layer = "ACPbyZipBenton30June_Project", verbose = FALSE) 

zip_laea <- spTransform(zip, CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"))
zip_laea@data$id <- rownames(zip_laea@data)
#plot(zip_laea)

#alaska <- zip_laea[zip_laea$state_fips=="02",]
alaskazip <- subset(zip_laea, state_fips=="02")
alaskazip <- elide(alaskazip, rotate=-39)
alaskazip <- elide(alaskazip, scale=max(apply(bbox(alaskazip), 1, diff)) / 2.3)
#alaska <- elide(alaska, shift=c(-3000000, 1200000))
alaskazip <- elide(alaskazip, shift=c(-2100000, -2500000)) #(shifts Alaska to SW also)
proj4string(alaskazip) <- proj4string(zip_laea)

#hawaii <- zip_laea[zip_laea$state_fips=="15",]
hawaiizip <- subset(zip_laea,state_fips=="15")
hawaiizip <- elide(hawaiizip, rotate=-35)
#hawaii <- elide(hawaii, shift=c(3500000, -1600000))
hawaiizip <- elide(hawaiizip, shift=c(5400000, -1400000)) #(shifts HI closer to TX)
proj4string(hawaiizip) <- proj4string(zip_laea)

zip_laea <- zip_laea[!zip_laea$state_fips %in% c("02", "15"),] # Remove old AK and HI
zip_laea <- rbind(zip_laea, alaskazip, hawaiizip) # Add in shifted AK and HI

AllZips <- spTransform(zip_laea,  CRS("+proj=longlat +datum=NAD83 +no_defs"))
#plot(AllZips)

#write edited version to gdb
arc.write("G:/My Drive/ACPdashboard/ACPzipMapData1Jul.shp", data = AllZips, overwrite = TRUE)

```



```{r ACP State Analysis,cache = TRUE,cache.lazy = FALSE, echo=FALSE, results='hide'}


#download household income data from acs at state level
HHincome_state.1 <- get_acs(survey = "acs5", geography = "state", table = "B19001", year = 2019, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names()  #download version without geography 

#download household income data from acs
totalHH_state <- get_acs(survey = "acs5", geography = "state", variables = "B19001_001", year = 2019, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate,moe) %>% rename("total_hh" = "estimate") %>%  #download version without geography 
mutate(total_hh = ifelse(total_hh == 0, moe, total_hh)) %>% select(-moe)
  
#download average household size from acs
HH.size_state <- get_acs(survey = "acs5", geography = "state", variables = "B25010_001", year = 2019, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE) %>% clean_names() %>% select(geoid,estimate) %>% rename("hh.size" = "estimate")



#combine acs income data with the max values of the income ranges, and average household size
HHincome_state.2 <- HHincome_state.1  %>% select(-moe) %>% left_join(y = inc.max.vals, by = c("variable" = "var"))  %>%
  mutate(acp_data = if_else(geoid %in% ACPstates$state_code, "y","n"),
    region = if_else(geoid == "02", "AK",
                if_else(geoid == "15", "HI", "L48"))) %>%
  left_join(y = HH.size_state, by = "geoid") %>%
 mutate(hh.size = if_else(is.na(hh.size) == TRUE, 2.62, hh.size), #for any places without an average household size, sets to the 2019 value (2.62)
   l48.fpl = (p148 + (p248*(hh.size - 1))), #creates fpl based on l48, ak, and hi values, then selects the appropriate value for "fpl"
                                     ak.fpl = (p1ak + (p2ak*(hh.size - 1))),
                                     hi.fpl = (p1hi + (p2hi*(hh.size - 1))),
                                     fpl = if_else(region == "L48", l48.fpl,
                                                   if_else(region == "AK", ak.fpl,hi.fpl))) %>%
  select(-ak.fpl, -hi.fpl, -l48.fpl, -region) %>%# removes the regional fpl values
  mutate(elig_200 = if_else(fpl >= max_income, "y","n")) %>% #denotes whether this income record includes eligible households
  subset(acp_data == "y" & variable != "B19001_001") %>% 
  subset(elig_200 == "y") %>% # retains only eligible income brackets and total # households
  select(geoid,name, estimate, hh.size, fpl) %>% group_by(geoid,name) %>%
  summarize(hh_qualify = sum(estimate))
                                                                                                                    
#join with total # households
HHincome_state.3 <- HHincome_state.2 %>% left_join(y = totalHH_state, by = "geoid") %>%
  left_join(y = ACPstates, by = c("geoid" = "state_code")) %>%
  mutate(HHqualify_perc = (hh_qualify/total_hh)*100, 
  HHEoE_perc = (HH_aug22/hh_qualify)*100) %>% ###NEED TO EDIT THIS ROW ANY TIME STATE DATA IS UPDATED###
  rename("totalHH"="total_hh", "HHqualify"="hh_qualify") %>%
  select(-geoid, -name, -state) %>%
  select(State, totalHH, HHqualify, HHqualify_perc, HH_aug22, HHEoE_perc)%>% 
  subset(geoid != "69" & geoid != "66" & geoid != "60" & geoid != "72" & geoid != "78") %>%
  rename("state" = "State") %>%
  ungroup()

   
#write.xlsx(x = HHincome_state.3, "C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACPbyState.xlsx")

#also write to google drive workbook for ACP dashboard
xlsx::write.xlsx("G:/My Drive/ACPdashboard/ACP_DASHBOARD.xlsx", sheetName = "EnrollByState", x = HHincome_state.3, append = TRUE)



 #original version---------  
#loads HH income fields from 5 year dataset (2015-2019) < $45K annual
# inc.vars <- c("B19001_001", "B19001_002", "B19001_003", "B19001_004", "B19001_005" , "B19001_006", "B19001_007", "B19001_008", "B19001_009" ) 
# 
# HH.var <- c("S1101_C01_001") #total number of households
# 
# #download state-level data from ACS 5 yr - 2020 vintage
# HHincome.1 <- get_acs(survey = "acs5", geography = "state", variables = inc.vars, year = 2020, geometry = FALSE, moe_level = 95, state = NULL,cache_table = TRUE)%>%
#   clean_names()  #download version without geography 
# 
# #wrangle into per-state records, so each variable is a column
# HHincome.2 <- HHincome.1  %>% select(-moe) %>% 
#   pivot_wider(id_cols = c("geoid", "name"), names_from = variable, values_from = estimate )  
#   
# #calculate sum of HH's across income variables - will be total HH w/ income < 45k within past 12 mo
# HHincome.3 <- HHincome.2 %>% mutate(HHincome = rowSums((HHincome.2[,4:11]),na.rm = TRUE)) %>% 
#   select( -B19001_002,-B19001_003, -B19001_004, -B19001_005, -B19001_006, -B19001_007, -B19001_008, -B19001_009) %>%
#   mutate(HH_perc = (HHincome/B19001_001)*100)#percent of households eligible for ACP 
# 
# #arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/HHeligible2021",data = HHincome.3)
# 
# 
# 
# 
# 
# #total HHs per state
# allHH <- get_acs(survey = "acs5", geography = "state", variables = HH.var, year = 2020, geometry = TRUE, state = NULL, moe_level = 95, cache_table = TRUE) %>% clean_names() %>% shift_geometry(preserve_area = FALSE, position = c("below","outside"))%>% 
#   subset(geoid != "69" & geoid != "66" & geoid != "60" & geoid != "72" & geoid != "78")






#-----------------
#summary of enrollment by state
# ACPstates <-read_excel(path = "G:/My Drive/ACPdashboard/ACPWeeklyEnroll.xlsx", sheet = 4, col_names = TRUE)  %>%
#   right_join(y = HHincome.3, by = c("State" = "name" )) %>% clean_names() %>% mutate(HHEoE_perc
#  = (hh_aug15/h_hincome)*100) %>% ###NEED TO EDIT THIS ROW ANY TIME STATE DATA IS UPDATED###
#   rename("totalHH"="b19001_001", "HHqualify"="h_hincome", "HHqualify_perc" ="hh_perc") %>%
#   select(-geoid)

#write to xlsx
#write.xlsx(x = ACPstates, "C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/Affordable-Connectivity-Program-Analysis/ACPbyState.xlsx")
#write to map gdb  
#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/ACPstates16AUG2022",data = ACPstates)

#also write to google drive workbook for ACP dashboard
#write.xlsx("G:/My Drive/ACPdashboard/ACP_DASHBOARD.xlsx", sheetName = "EnrollByState", x = ACPstates, OVERWRITE = TRUE)

```

```{r model enrollment data,cache = TRUE,cache.lazy = FALSE, echo=FALSE}

#continuous growth model - simple regression based on observed enrollment through 22 Mar 2022



#data includes growth observered during EBB program to better inform the model
acp_mod1 <- lm(allHH ~ monthBYyear, data = acp_national) 
glance(acp_mod1)#summary details of the model

#predict total spent to 240 months past Mar 2022
acp_predict1 <- predict.lm(acp_mod1, newdata = future, se.fit = TRUE, level = .95, interval = "prediction") 

enrolled <- max(US_enrolled$allHH)


##calculate #HH for % enrollment caps

#enrollment cap based on current enrollment
US_eligibleHH.current <- US_eligibleHH*(US_HHEoE/100)
#30% of HHs that qualify for ACP and enroll
#US_eligibleHH30 <- US_eligibleHH*.30
#40% of HHs that qualify for ACP and enroll
US_eligibleHH40 <- US_eligibleHH*.40
#45% of HHs that qualify for ACP and enroll
US_eligibleHH45 <- US_eligibleHH*.45
#50% of HHs that qualify for ACP and enroll
US_eligibleHH50 <- US_eligibleHH*.5
#75% of HHs that qualify for ACP and enroll
US_eligibleHH75 <- US_eligibleHH*.75

acp_ToPlot1 <- data.frame(acp_predict1$fit) %>% mutate(month = 9:234) %>% rename(enrolled = fit)#create index which represents months - currently predicting Sep 2022 and beyond

#create ACP-only vector (selects only months after switch from EBB to ACP)
ACP.only <- acp_national %>% subset(monthBYyear >= 9) %>% select(month, allHH) %>% rename(enrolled = allHH)

ebb.acp <- 1257588871 + 14200000000 #remaining amount of EBB fund + full ACP fund

#calculates amount of fund used with enrollment remaining at current percent of eligible HH
x <- round(US_HHEoE,0)
y <- round((US_eligibleHH.current/1000000), 1)
enroll.current <- acp_ToPlot1 %>% subset(enrolled <  US_eligibleHH.current) %>% bind_rows(ACP.only) %>% arrange(month) 
enroll.currentb <- enroll.current %>% bind_rows(enroll.current[rep(nrow(enroll.current), 36),] %>%
              mutate(month = month + seq(36))) %>% #creates a month sequence, to project out to 36 months
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent), #estimates monthly spent (based only on enrollment & cumulative spent)
                     perc.enrolled = (enrolled/US_eligibleHH)*100 , perc.used = (cum.spent/ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 44)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25/ebb.acp)*100, #adds in an extra 2.5% that Ry suggested to incorporate higher tribal value and device spending
         model = paste0(x, " Percent Enrollment" ," (",y," Million Households)"))
enroll.currentb$month  <- format(enroll.currentb$month, format = "%b-%y") #pastes dynamic label for Tableau display

write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           sheetName = "enroll_current",colNames = TRUE, overwrite = TRUE, x = enroll.currentb)

#xlsx::write.xlsx("G:/My Drive/ACPdashboard/ACP_DASHBOARD.xlsx", sheetName = "SpotCheck", x = enroll.currentb, append = TRUE)
#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/enroll35", data = enroll35b)


#calculates amount of fund used until %30 enrollment is observed
# enroll30 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH30) %>% bind_rows(ACP.only) %>% arrange(month) 
# enroll30b <- enroll30 %>% bind_rows(enroll30[rep(nrow(enroll30), 36),] %>%
#               mutate(month = month + seq(36))) %>%
#               mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /14200000000)*100,
#                       month = seq(as.Date("2021-01-01"), by = "month",length.out = 44)) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100, model = "30 Percent Enrollment (11 Million Households")
# enroll30b$month <- format(enroll30b$month, format = "%b-%y")
# 
# write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
#            sheetName = "enroll30",colNames = TRUE, append = TRUE, x = enroll30b)

#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/enroll30", data = enroll30b)

#calculates amount of fund used until %40 enrollment is observed
enroll40 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH40) %>% bind_rows(ACP.only) %>% arrange(month) 
enroll40b <- enroll40 %>% bind_rows(enroll40[rep(nrow(enroll40), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 46)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "40 Percent Enrollment (14.7 Million Households)")
enroll40b$month <- format(enroll40b$month, format = "%b-%y")

write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           sheetName = "enroll40",colNames = TRUE, append = TRUE, x = enroll40b)

#calculates amount of fund used until %45 enrollment is observed
enroll45 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH45) %>% bind_rows(ACP.only) %>% arrange(month) 
enroll45b <- enroll45 %>% bind_rows(enroll45[rep(nrow(enroll45), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 48)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "45 Percent Enrollment (16.5 Million Households)") 
enroll45b$month <- format(enroll45b$month, format = "%b-%y")

write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           sheetName = "enroll45",colNames = TRUE, append = TRUE, x = enroll45b)

#calculates amount of fund used until %50 enrollment is observed
enroll50 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH50) %>% bind_rows(ACP.only) %>% arrange(month) 
enroll50b <- enroll50 %>% bind_rows(enroll50[rep(nrow(enroll50), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 50)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "50 Percent Enrollment (18.3 Million Households)") 
enroll50b$month <- format(enroll50b$month, format = "%b-%y")

write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           sheetName = "enroll50",colNames = TRUE, append = TRUE, x = enroll50b)

#calculates amount of fund used until %75 enrollment is observed #NOT REACHED, SO USING AS CONTINUOUS GROWTH##
enroll75 <- acp_ToPlot1 %>% subset(enrolled < US_eligibleHH75) %>% bind_rows(ACP.only) %>% arrange(month) 
enroll75b <- enroll75 %>% bind_rows(enroll75[rep(nrow(enroll75), 36),] %>%
              mutate(month = month + seq(36))) %>%
              mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
                     perc.enrolled = (enrolled/US_eligibleHH)*100 ,perc.used = (cum.spent /ebb.acp)*100,
                     month = seq(as.Date("2022-01-01"), by = "month",length.out = 62)) %>%
  select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
  mutate(month.spent25 = month.spent * 1.025,cum.spent25 = cumsum(month.spent25), perc.used25 = (cum.spent25 /ebb.acp)*100, model = "Continuous Enrollment Growth (no limit)") 
enroll75b$month <- format(enroll75b$month, format = "%b-%y")

write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
           sheetName = "enroll75",colNames = TRUE, append = TRUE, x = enroll75b)



modeldata <- bind_rows(enroll.currentb,
                       #enroll30b,
                       enroll40b,
                       enroll45b,
                       enroll50b,
                       enroll75b)

p <- modeldata$cum.spent25/ebb.acp
z <- 1.96
q <- 1 - p
se <- sqrt((p*q)/ebb.acp)
CI <- z*se
modeldataCI <- modeldata %>% mutate(upperCI = (p + CI), lowerCI = (p - CI))


plot <- ggplot(modeldataCI, aes(x = month, y = p, group=model)) +
   #xlim("Jan-21","Feb-26") +
   ylim(0,1.5) +
  geom_line(aes(colour=model)) + theme_classic() +geom_hline(yintercept = 1) 

acpTESTplot <- plotly::ggplotly(plot) #converts plot to interactive version

saveWidget(acpTESTplot,"ACPtest.html", selfcontained = F, libdir = "lib")

zip(zipfile = "acpTESTplot.zip",files = c("ACPtest.html","lib"))

xlsx::write.xlsx("G:/My Drive/ACPdashboard/ACP_DASHBOARD.xlsx", sheetName = "ModelData1", x = modeldata, append = TRUE)

```

```{r model funds data,cache = TRUE,cache.lazy = FALSE, echo=FALSE}

#continuous growth model - simple regression based on observed enrollment through 22 Mar 2022
#data includes growth observered during EBB program to better inform the model
acp_spentmod <- lm(TotalUsed2.5 ~ monthBYyear, data = ACP) 
glance(acp_spentmod)#summary details of the model

#predict total spent to 240 months past Mar 2022
acp_predictspent <- predict.lm(acp_spentmod, newdata = future, se.fit = TRUE, level = .95, interval = "prediction") 

#total amount in fund
ALLfund <- 14200000000

#35% of fund spent
ALLfund35 <- ALLfund*.35
#40% of fund spent
ALLfund40 <- ALLfund*.40
#45% of fund spent
ALLfund45 <- ALLfund*.45
#50% of fund spent
ALLfund50 <- ALLfund*.5
#75% of fund spent
ALLfund75 <- ALLfund*.75
acp_fundToPlot1 <- data.frame(acp_predictspent$fit) %>% mutate(month = 8:233) %>% rename(spent = fit)#create index which represents months - currently predicting July 2022 and beyond

#create ACP-only vector (selects only months after switch from EBB to ACP)
ACPspent.only <- ACP %>% subset(monthBYyear >= 9) %>% select(month, TotalUsed) %>% rename(spent = TotalUsed)

#calculates amount of fund used until %50 enrollment is observed
spent35 <- acp_fundToPlot1 %>% subset(spent < ALLfund35) %>% bind_rows(ACPspent.only) %>% arrange(month) %>% mutate(model = "35")
# spent35b <- ALLfund35 %>% bind_rows(ALLfund35[rep(nrow(ALLfund35), 36),] %>%
#               mutate(month = month + seq(36))) %>%
#               mutate(month.spent = spent*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/totalHH)*100 ,perc.used = (cum.spent /14200000000)*100) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100, model = "35")

#write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
          # sheetName = "enroll35",col.names = TRUE, append = TRUE, x = enroll35b)

#arc.write("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb/enroll35", data = enroll35b)

#calculates amount of fund used until %40 enrollment is observed
spent40 <- acp_fundToPlot1 %>% subset(spent < ALLfund40) %>% bind_rows(ACPspent.only) %>% arrange(month) %>% mutate(model = "40")
# enroll40b <- enroll40 %>% bind_rows(enroll40[rep(nrow(enroll40), 24),] %>%
#               mutate(month = month + seq(24))) %>%
#               mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/totalHH)*100 ,perc.used = (cum.spent /14200000000)*100) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100, model = "40")
# #write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
#            sheetName = "enroll40",col.names = TRUE, append = TRUE, x = enroll40b)

#calculates amount of fund used until %45 enrollment is observed
spent45 <- acp_fundToPlot1 %>% subset(spent < ALLfund45) %>% bind_rows(ACPspent.only) %>% arrange(month) %>% mutate(model = "45")
# enroll45b <- enroll45 %>% bind_rows(enroll45[rep(nrow(enroll45), 24),] %>%
#               mutate(month = month + seq(24))) %>%
#               mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/totalHH)*100 ,perc.used = (cum.spent /14200000000)*100) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100, model = "45") 
# #write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
#            sheetName = "enroll45",col.names = TRUE, append = TRUE, x = enroll45b)

#calculates amount of fund used until %50 enrollment is observed
spent50 <- acp_fundToPlot1 %>% subset(spent < ALLfund50) %>% bind_rows(ACPspent.only) %>% arrange(month) %>% mutate(model = "50")
# enroll50b <- enroll50 %>% bind_rows(enroll50[rep(nrow(enroll50), 24),] %>%
#               mutate(month = month + seq(24))) %>%
#               mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/totalHH)*100 ,perc.used = (cum.spent /14200000000)*100) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100, model = "50") 
# #write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
#            sheetName = "enroll50",col.names = TRUE, append = TRUE, x = enroll50b)

#calculates amount of fund used until %75 enrollment is observed
spent75 <- acp_fundToPlot1 %>% subset(spent < ALLfund75) %>% bind_rows(ACPspent.only) %>% arrange(month) %>% mutate(model = "75")
# enroll75b <- enroll75 %>% bind_rows(enroll75[rep(nrow(enroll75), 24),] %>%
#               mutate(month = month + seq(24))) %>%
#               mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/totalHH)*100 ,perc.used = (cum.spent /14200000000)*100) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100, model = "75") 
# #write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
#            sheetName = "enroll75",col.names = TRUE, append = TRUE, x = enroll75b)



#calculates amount of fund used until %100 enrollment is observed
spent100 <- acp_fundToPlot1 %>% subset(spent < ALLfund) %>% bind_rows(ACPspent.only) %>% arrange(month) %>% mutate(model = "100")
# enroll100b <- enroll100 %>% bind_rows(enroll100[rep(nrow(enroll100), 24),] %>%
#               mutate(month = month + seq(24))) %>%
#               mutate(month.spent = enrolled*30, cum.spent = cumsum(month.spent),
#                      perc.enrolled = (enrolled/totalHH)*100 ,perc.used = (cum.spent /14200000000)*100) %>%
#   select(month, enrolled, lwr, upr,perc.enrolled,month.spent,cum.spent, perc.used) %>%
#   mutate(cum.spent25 = cum.spent*1.025, perc.used25 = (cum.spent25 /14200000000)*100) %>%
# #write.xlsx("C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/BroadbandFunds/ACPmodel.xlsx",
#            sheetName = "enroll100",col.names = TRUE, append = TRUE)

spentmodeldata <- bind_rows(spent35, spent40, spent45, spent50, spent75, spent100)


spentmodeldata %>% subset(model == "50" & spent < ALLfund) %>%  ggplot( aes(x = month, y = spent, group=model)) +
  geom_line(col="black") + 
  geom_point() + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill=model),
              alpha=0.1,
              linetype="solid",
              color="grey")

write.xlsx("G:/My Drive/ACPdashboard/ACPmodel.xlsx", sheetName = "ModelData", x = modeldata)

spend.rate <- lm(enroll75b$cum.spent ~ enroll75b$month) #estimate monthly spending rate
spend.rate25 <- lm(enroll75b$cum.spent25 ~ enroll75b$month) #estimate monthly spending rate

```

```{r Summary Stats,cache = TRUE,cache.lazy = FALSE, echo=FALSE}
NTspent <- sum(acp_national$nt_fund)
Tspent <- sum(acp_national$t_fund)
ALLspent <- sum(acp_national$TotalUsed)
ALLfund <- 14200000000
percentSpent <- acp_national %>% select(nt_fund,t_fund, TotalUsed) %>% ungroup() %>% summarize(percent_nt = (NTspent/ALLspent) * 100, percent_t = (Tspent/ALLspent)*100, percent_all = (ALLspent/ALLfund) * 100)

total.enrolled <- max(ACP$allHH)
tribal.enrolled <- max(ACP$tHH)
nontribal.enrolled <- max(ACP$ntHH)
peak.spent <- tribal.enrolled*75 + nontribal.enrolled*30
 

#alternative spent calculation requested by Chris
##total spent (EBB + ACP)
f.spent <- 1878411129 + 1847281946 #June zip data (sum of total support column)
f.allotted <- 3136000000 + 14200000000
f.spent/f.allotted
f.allotted - f.spent
```


```{r State Map data,cache = TRUE,cache.lazy = FALSE, echo=FALSE}

#us <- states(cb = TRUE, year = 2020)
us <- readOGR(dsn = "C:/Users/chris/Dropbox (ILSR)/Christine Parker/Projects/CBN InfoMap Requests/BroadbandingFunds/ACP/ACP/ACP.gdb",
           layer = "USA_States_Generalized", verbose = FALSE) %>% 
  subset(STATE_FIPS != "69" & STATE_FIPS != "66" & STATE_FIPS != "60" & STATE_FIPS != "72" & STATE_FIPS != "78")
us_laea <- spTransform(us, CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs"))
us_laea@data$id <- rownames(us_laea@data)
plot(us_laea)

alaska <- us_laea[us_laea$STATE_FIPS=="02",]
alaska <- elide(alaska, rotate=-39)
alaska <- elide(alaska, scale=max(apply(bbox(alaska), 1, diff)) / 2.3)
#alaska <- elide(alaska, shift=c(-3000000, 1200000))
alaska <- elide(alaska, shift=c(-2100000, -2500000)) #(shifts Alaska to SW also)
proj4string(alaska) <- proj4string(us_laea)

hawaii <- us_laea[us_laea$STATE_FIPS=="15",]
hawaii <- elide(hawaii, rotate=-35)
#hawaii <- elide(hawaii, shift=c(3500000, -1600000))
hawaii <- elide(hawaii, shift=c(5400000, -1400000)) #(shifts HI closer to TX)
proj4string(hawaii) <- proj4string(us_laea)

us_laea <- us_laea[!us_laea$STATE_FIPS %in% c("02", "15"),] # Remove old AK and HI
us_laea <- rbind(us_laea, alaska, hawaii) # Add in shifted AK and HI

AllStates <- spTransform(us_laea, proj4string(us))
plot(AllStates)

#write edited version to gdb
arc.write("G:/My Drive/ACPdashboard/StateBoundsLayer", data = AllStates, overwrite = TRUE)
```
